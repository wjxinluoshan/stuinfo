<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>学生信息录入</title>
  <link rel="stylesheet" href="/stuinfo/layui/css/layui.css">
  <script src="/stuinfo/layui/layui.js"></script>
  <script src="/stuinfo/js/vue.js"></script>
  <script src="/stuinfo/js/jquery.min.js"></script>
</head>
<body>
<table class="layui-table" lay-even lay-skin="nob" width="100%" id="table_input_info_id">
  <tr>
    <!--    手动输入信息  -->
    <td>
      <div class="layui-form">

        <div class="layui-form-item" pane>
          <label class="layui-form-label">学号</label>
          <div class="layui-input-inline">
            <input type="text" v-model="stuNumber" required lay-verify="required" autocomplete="off"
                   class="layui-input">
          </div>
        </div>

        <div class="layui-form-item" pane>
          <label class="layui-form-label">班级</label>
          <div class="layui-input-inline">
            <input type="text" v-model="stuClass" required lay-verify="required" autocomplete="off"
                   class="layui-input">
          </div>
        </div>

        <div class="layui-form-item" pane>
          <label class="layui-form-label">姓名</label>
          <div class="layui-input-inline">
            <input type="text" v-model="name" required lay-verify="required" autocomplete="off"
                   class="layui-input">
          </div>
        </div>

        <div class="layui-form-item" pane>
          <label class="layui-form-label">密码</label>
          <div class="layui-input-inline">
            <input type="text" value="123456" disabled required lay-verify="required"
                   autocomplete="off" class="layui-input">
          </div>
        </div>

        <div class="layui-form-item">
          <label class="layui-form-label">所在学院</label>
          <div class="layui-input-inline">
            <select lay-filter="collegeChange" name="college" id="college_select_id">
              <option value="">请选择一个学院</option>
              <option v-for="(college,index) in colleges"
                      :value="index">{{college}}
              </option>
            </select>
          </div>
        </div>

        <div class="layui-form-item">
          <label class="layui-form-label">所在系</label>
          <div class="layui-input-inline">
            <select name="depart" id="depart_select_id">
              <option value="">请选择一个系</option>
              <option v-for="(depart,index) in departs" :value="index">{{depart}}</option>
            </select>
          </div>
        </div>

        <div class="layui-form-item" pane>
          <label class="layui-form-label">手机号码</label>
          <div class="layui-input-inline">
            <input type="text" v-model="phone" required lay-verify="required" autocomplete="off"
                   class="layui-input">
          </div>
        </div>

        <div class="layui-form-item" pane>
          <label class="layui-form-label">入学年线</label>
          <div class="layui-input-inline">
            <input type="text" v-model="inSchoolYear" required lay-verify="required"
                   autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" @click="uploadInfo">立即提交</button>
            <button @click="reset" class="layui-btn layui-btn-primary">重置</button>
          </div>
        </div>
      </div>
    </td>
    <td></td>
  </tr>
</table>
<input type="file" accept=".xls,.xlsx" id="input_file_id"/>
<button class="layui-btn layui-btn-radius layui-btn-primary" id="btn_upload_id">上传文件</button>
</body>
<script>
  //注意：导航 依赖 element 模块，否则无法进行功能性操作
  layui.use('element', function () {
    var element = layui.element;

    //…
  });

  layui.use('form', function () {
    /**
     * 学院选择事件
     */
    layui.form.on('select(collegeChange)', function () {
      let collegeIndex = $('#college_select_id').val();
      if (collegeIndex) {
        queryDepart(collegeIds[collegeIndex])
      } else {
        table_input_info_id_vue.departs = [];
        renderFrom();
      }
    });
  });
</script>
<script src="/stuinfo/js/requestSchoolInfo.js"></script>
<script src="/stuinfo/js/json2.js"></script>
<script>

  var collegeIds = [];
  var departIds = [];
  /**
   * 手动输入数据vue
   */
  var table_input_info_id_vue = new Vue({
    el: '#table_input_info_id',
    data: {
      stuNumber: '',
      stuClass: '',
      name: '',
      password: '',
      phone: '',
      inSchoolYear: '',
      colleges: [],
      departs: [],
    },
    methods: {
      uploadInfo() {
        if (!this.stuNumber.trim()) {
          myAlert('学号不能为空!!!');
          return;
        }
        if (!this.stuClass.trim()) {
          myAlert('学生班级不能为空!!!');
          return;
        }
        if (!this.name.trim()) {
          myAlert('学生姓名不能为空!!!');
          return;
        }
        if (!this.inSchoolYear.trim()) {
          myAlert('学生入学年线不能为空!!!');
          return;
        }

        if (!$('#college_select_id').val() || !$('#depart_select_id').val()) {
          myAlert('学生所在院系不能不选!!!');
          return;
        }
        let formData = new FormData();

        formData.append('isTeacher', "1");
        formData.append('stus', JSON.stringify({
          stuNumber: this.stuNumber.trim(),
          stuClass: this.stuClass,
          name: this.name.trim(),
          college: collegeIds[$('#college_select_id').val()],
          depart: departIds[$('#depart_select_id').val()],
          phone: this.phone.trim(),
          inSchoolYear: this.inSchoolYear.trim()
        }));

        uploadInfo(formData, true)

      },
      reset() {
        this.stuNumber = '';
        this.stuClass = '';
        this.name = '';
        this.password = '';
        this.phone = '';
        this.inSchoolYear = '';
        $('#college_select_id').val('');
        $('#depart_select_id').val('');
      }
    },
  });

  /**
   * 获取学院信息
   */
  requestSchoolInfo('/stuinfo/sic/qcs', {}).then(colleges => {
    if (colleges) {
      let tempColleges = [];
      let tempCollegeIds = [];
      colleges.forEach((college) => {
        try {
          tempColleges.push(college.college);
          tempCollegeIds.push(college.id);
        } catch (e) {
          console.log(e)
        }
      });
      if (tempColleges.length > 0) {
        table_input_info_id_vue.colleges = tempColleges;
        collegeIds = tempCollegeIds;
      }
      renderFrom();
      return;
    }
    myAlert('获取学院信息失败!!!');
  });

  function queryDepart(id) {
    requestSchoolInfo('/stuinfo/sic/qds', {collegeId: id}).then(departs => {
      if (departs) {
        let tempDeparts = [];
        let tempdependIds = [];
        departs.forEach((depart) => {
          try {
            /**
             *返回的数据形式为[{},{},{}]
             */
            tempDeparts.push(depart.depart);
            tempdependIds.push(depart.id);
          } catch (e) {
          }
        });
        if (tempDeparts.length > 0) {
          table_input_info_id_vue.departs = tempDeparts;
          departIds = tempdependIds;
        }
        renderFrom();
        return;
      }
      myAlert('获取系信息失败!!!');

    });
  }

  var fileOfUpload = '';
  /**
   * 监听文件选择事件
   */
  document.getElementById('input_file_id').onchange = function () {
    fileOfUpload = this.files[0];
  };

  /**
   * 文件上传
   */
  $('#btn_upload_id').on('click', () => {
    if (fileOfUpload) {
      let formData = new FormData();
      formData.append('file', fileOfUpload);
      formData.append('isTeacher', "1");
      uploadInfo(formData);
    } else {
      myAlert("请选择一个.xls或者.xlsx文件!!!")
    }
  });

  function uploadInfo(formData, isInput) {
    $.ajax({
      type: "POST",
      url: '/stuinfo/sctc/isot',
      data: formData,
      contentType: false,
      processData: false,
      success: function (response) {
        if (response) {
          if (isInput) {
            table_input_info_id_vue.reset();
          }
          myAlert('上传成功!!!');
        } else {
          myAlert('上传失败!!!');
        }
      },
      error: function (e) {
        myAlert('上传失败!!!');
      }
    });

  }

  function myAlert(content) {
    layer.open({
      title: '提示'
      , content: content
    });
  }

  //延迟重新渲染
  function renderFrom() {
    setTimeout(function () {
      layui.form.render();
    }, 100);
  }

</script>
</html>