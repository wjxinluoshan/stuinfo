<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>学生信息管理</title>
  <link rel="stylesheet" href="/stuinfo/layui/css/layui.css">
  <script src="/stuinfo/layui/layui.js"></script>
  <script src="/stuinfo/js/vue.js"></script>
  <script src="/stuinfo/js/jquery.min.js"></script>
  <style>
    td {
      text-align: center;
      width: 190px
    }
  </style>
</head>
<body>
<!--

条件查询区域

-->
<table class="layui-table" lay-skin="line" id="table_info_id">
  <tbody>
  <tr>
    <td>查询条件</td>
    <td>
      <button class="layui-btn layui-btn-radius layui-btn-primary" @click="queryUserInfo(1)">查询
      </button>
    </td>
  </tr>
  <tr>
    <td>
      <div class="layui-input-inline">
        <input type="text" v-model="inputUserNumber" placeholder="学生学号"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
    <td>
      <div class="layui-input-inline">
        <input type="text" v-model="inputStuClass" placeholder="学生班级"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
  </tr>
  <tr>
    <td>
      <div class="layui-input-inline">
        <input type="text" v-model="inputDepart" placeholder="所在系"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
    <td>
      <div class="layui-input-inline">
        <input type="text" v-model="inputSchoolYear" placeholder="入学年线"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
  </tr>
  </tbody>
</table>
<!--

查询数据显示区域

-->
<table class="layui-table" lay-skin="line" id="table_info_show_id" style="overflow-x: scroll">
  <tr>查询结果显示区域</tr>
  <thead>
  <tr>
    <td>修改</td>
    <td>删除</td>
    <td>学号</td>
    <td>班级</td>
    <td>姓名</td>
    <td>密码</td>
    <td>学院</td>
    <td>系</td>
    <td>手机号</td>
    <td>入学年限</td>
  </tr>
  </thead>
  <tr v-for="(stuNumber,index) in stuNumbers">
    <td>
      <button @click="edit(index)" class="layui-btn layui-btn-radius">修改</button>
    </td>
    <td>
      <button @click="del(index)" class="layui-btn layui-btn-radius layui-btn-danger">删除</button>
    </td>
    <td>
      <div class="layui-input-inline" style=" width: 190px">
        <input type="text" :value="stuNumber" :id="'stuNumber'+index"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
    <td>
      <div class="layui-input-inline" style=" width: 190px">
        <input type="text" :value="stuClasses[index]" :id="'stuClass'+index"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
    <td>
      <div class="layui-input-inline" style=" width: 190px">
        <input type="text" :value="names[index]" :id="'name'+index"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
    <td>
      <div class="layui-input-inline" style=" width: 190px">
        <input type="text" :value="passwords[index]" :id="'password'+index"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
    <td>
      <div class="layui-form layui-input-inline" style=" width: 190px">
        <div class="layui-form-item">
          <div class="layui-input-inline">
            <select name="college" :id="'change_college_id'+index">
              <option value="0">{{collegeInColleges[index][0]}}</option>
              <option v-for="(college,i) in collegeInColleges[index]"
                      :value="i" v-if="i !== 0">{{college}}
              </option>
            </select>
          </div>
        </div>
      </div>
    </td>
    <td>
      <div class="layui-form layui-input-inline" style=" width: 190px">
        <div class="layui-form-item">
          <div class="layui-input-inline">
            <select name="depart" :id="'change_depart_id'+index">
              <option value="index">{{departInDeparts[index][0]}}</option>
              <option v-for="(depart,i) in departInDeparts[index]"
                      :value="i" v-if="i !== 0">{{depart}}
              </option>
            </select>
          </div>
        </div>
      </div>
    </td>
    <td>
      <div class="layui-input-inline" style=" width: 190px">
        <input type="text" :value="phones[index]" :id="'phone'+index"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
    <td>
      <div class="layui-input-inline" style=" width: 190px">
        <input type="text" :value="inSchoolYears[index]" :id="'inSchoolYear'+index"
               autocomplete="off"
               class="layui-input">
      </div>
    </td>
  </tr>
  <tr>
    <td>
      <div id="page_div_id" v-if="stuNumbers.length>0"></div>
    </td>
  </tr>
  <tbody>
  </tbody>
</table>
</body>
<script src="/stuinfo/js/requestSchoolInfo.js"></script>
<script>
  //注意：导航 依赖 element 模块，否则无法进行功能性操作
  layui.use('element', function () {
    var element = layui.element;

    //…
  });

  layui.use('form', function () {
    /**
     * 学院选择事件
     */
    // layui.form.on('select(collegeChange)', function () {
    //   let collegeIndex = $('#college_select_id').val();
    //   if (collegeIndex) {
    //     queryDepart(collegeIds[collegeIndex])
    //   } else {
    //     table_input_info_id_vue.departs = [];
    //     renderFrom();
    //   }
    // });
  });
</script>
<script>
  var table_info_id_vue = new Vue({
    el: '#table_info_id',
    data: {
      /**
       *查询条件
       */
      inputUserNumber: '',
      inputStuClass: '',
      inputDepart: '',
      inputSchoolYear: '',
    },
    methods: {
      /**
       * 信息查询
       */
      queryUserInfo(type) {
        //老师
        if (type === 0) {

        }
        //学生
        else if (type === 1) {
          let studentCondition = {};
          //学生查询条件
          if (this.inputUserNumber.trim()) {
            studentCondition.stuNumber = this.inputUserNumber.trim();
          }
          if (this.inputStuClass.trim()) {
            studentCondition.stuClass = this.inputStuClass.trim();
          }
          if (this.inputDepart.trim()) {
            studentCondition.depart = this.inputDepart.trim();
          }
          if (this.inputSchoolYear.trim()) {
            studentCondition.inSchoolYear = this.inputSchoolYear.trim();
          }
          if (Object.keys(studentCondition).length === 0) {
            myAlert('请至少选择一个输入条件!!!');
            return;
          }
          queryUserInfo('/stuinfo/sctc/qsis', studentCondition);
        }
      }
    }
  });

  function queryUserInfo(url, data) {
    $.post(url, data, function (response) {
      try {
        if (response) {
          if (response.length > 0) {
            let t1 = [], t2 = [], t3 = [], t4 = [], t5 = [], t6 = [], t7 = [], t8 = [];
            response.forEach((obj, index) => {
              t1.push(obj.stuNumber);
              t2.push(obj.stuClass);
              t4.push(obj.password);
              t3.push(obj.name);
              //学院和系都是id
              // t5.push(obj.college);
              // t6.push(obj.depart);
              t7.push(obj.phone);
              t8.push(obj.inSchoolYear);

              queryDepart(obj.college, obj.depart, index);
            });
            if (t1.length > 0) {
              table_info_show_id_vue.stuNumbers = t1;
              table_info_show_id_vue.stuClasses = t2;
              table_info_show_id_vue.names = t3;
              table_info_show_id_vue.passwords = t4;
              // table_info_show_id_vue.collegeIds = t5;
              // table_info_show_id_vue.departInDepartsIds = t6;
              table_info_show_id_vue.phones = t7;
              table_info_show_id_vue.inSchoolYears = t8;
              table_info_show_id_vue.collegeInColleges = outerCollegeInColleges;
              table_info_show_id_vue.departInDeparts = outerDepartInDeparts;

            }
          } else {
            myAlert('没有满足以上条件的数据!!!')
          }
          return;
        }
        myAlert('查询失败!!!');
      } catch (e) {
      }
    }).fail(function () {
      myAlert('查询出现异常!!!');
    })
  }
</script>

<script>

  var outerColleges = [];
  var collegeIds = [];

  var outerCollegeInColleges = [];
  var outerDepartInDeparts = [];
  var departInDepartsDependCollegeIds = [];
  var departInDepartsIds = [];
  // var pageOfLimit = 10;
  /**
   * 查询结果显示区域
   */

  var table_info_show_id_vue = new Vue({
    el: '#table_info_show_id',
    data: {
      stuNumbers: [],
      stuClasses: [],
      names: [],
      passwords: [],
      phones: [],
      inSchoolYears: [],

      collegeInColleges: [],
      departInDeparts: [],
      //id
      collegeIds: [],
      departIds: [],
    },
    updated: function () {
      this.$nextTick(function () {
        setTimeout(function () {
          layui.form.render();
        }, 100);
        layui.use('laypage', function () {
          var laypage = layui.laypage;
          //执行一个laypage实例
          //默认limit:10
          laypage.render({
            elem: 'page_div_id' //注意，这里的 test1 是 ID，不用加 # 号
            , count: table_info_show_id_vue.stuNumbers.length //数据总数，从服务端得到
            , jump: function (obj, first) {
              //obj包含了当前分页的所有参数，比如：
              console.log(obj.curr); //得到当前页，以便向服务端请求对应页的数据。
              // console.log(obj.limit); //得到每页显示的条数

              //首次不执行
              if (!first) {
                //do something
              }
            }
          });
        });
      })
    },
    methods: {
      edit(index) {
      },
      del(index) {

      },
    }
  });

  /**
   * 获取学院信息
   */
  function queryColleges() {
    requestSchoolInfo('/stuinfo/sic/qcs', {}).then(colleges => {
      if (colleges) {
        let tempColleges = [];
        let tempCollegeIds = [];
        colleges.forEach((college) => {
          try {
            tempColleges.push(college.college);
            tempCollegeIds.push(college.id);
          } catch (e) {
            console.log(e)
          }
        });
        if (tempColleges.length > 0) {
          outerColleges = tempColleges;
          collegeIds = tempCollegeIds;
        }
        // renderFrom();
        return;
      }
      myAlert('获取学院信息失败!!!');
    });
  }

  queryColleges();

  /**
   * 获取系信息
   */

  function queryDepart(collegeId, departId, index) {
    $.ajax({
      method: 'post',
      url: '/stuinfo/sic/qds',
      data: {collegeId: collegeId},
      async: false,
      success: function (departs) {
        if (departs) {
          let tempDeparts = [];
          let tempDependCollegeIds = [];
          let tempDepartIds = [];
          departs.forEach((depart) => {
            try {
              /**
               *返回的数据形式为[{},{},{}]
               */
              tempDeparts.push(depart.depart);
              tempDependCollegeIds.push(depart.collegeId);
              tempDepartIds.push(depart.id);
            } catch (e) {
            }
          });
          if (tempDeparts.length > 0) {
            let tempColleges = [];
            tempColleges.push(outerColleges[collegeIds.indexOf(collegeId)]);
            for (let outerCollege of outerColleges) {
              if (tempColleges.indexOf(outerCollege) === -1) {
                tempColleges.push(outerCollege);
              }
            }
            console.log(tempColleges)
            //系下拉框第一个显示得操作
            let departIndex = tempDepartIds.indexOf(departId);
            let a = tempDeparts[0];
            tempDeparts[0] = tempDeparts[departIndex];
            tempDeparts[departIndex] = a;
            let b = tempDependCollegeIds[0];
            tempDependCollegeIds[0] = tempDependCollegeIds[departIndex];
            tempDependCollegeIds[departIndex] = b;
            let c = tempDeparts[0];
            tempDepartIds[0] = tempDepartIds[departIndex];
            tempDepartIds[departIndex] = c;

            outerDepartInDeparts[index] = tempDeparts;
            departInDepartsDependCollegeIds[index] = tempDependCollegeIds;
            departInDepartsIds[index] = tempDepartIds;
            outerCollegeInColleges[index] = tempColleges;
          }
          return;
        }
        myAlert('获取系信息失败!!!');
      }
    })
    ;
  }

  function myAlert(content) {
    layer.open({
      title: '提示'
      , content: content
    });
  }

</script>

</html>